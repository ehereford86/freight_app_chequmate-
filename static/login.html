<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chequmate â€” Log In</title>
  <style>
    :root{
      --bg: #f3f4f6;              /* light gray page */
      --panel: #ffffff;           /* main panel */
      --muted: #6b7280;           /* gray text */
      --text: #111827;            /* near-black */
      --border: #d1d5db;          /* light border */
      --divider: #e5e7eb;         /* divider line */
      --shadow: 0 8px 30px rgba(0,0,0,.10);

      /* Chequmate brand (not BOA red) */
      --brand: #0f766e;           /* teal */
      --brand2: #0b4f4a;          /* deeper teal */
      --btn: #0f766e;
      --btnHover: #0b5f58;

      --link: #0f766e;
      --linkHover: #0b5f58;

      --danger: #b91c1c;
      --ok: #065f46;

      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background: var(--bg);
    }

    /* Top header */
    .topbar{
      background: #fff;
      border-bottom: 1px solid var(--divider);
    }
    .topwrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      user-select:none;
      min-width: 260px;
    }

    /* Uses your optional logo file if present */
    .logoBox{
      width: 44px;
      height: 44px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(15,118,110,.12), rgba(11,79,74,.08));
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .logoBox img{
      width:100%;
      height:100%;
      object-fit:contain;
      background:#fff;
    }
    .logoFallback{
      font-weight: 900;
      font-family: var(--mono);
      color: var(--brand2);
      letter-spacing: .5px;
      font-size: 14px;
    }

    .wordmark{
      font-weight: 900;
      letter-spacing: 2.5px;
      font-size: 20px;
      text-transform: uppercase;
      line-height: 1.05;
    }
    .tagline{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .pageTitle{
      font-weight: 800;
      font-size: 18px;
      color: #374151;
      white-space:nowrap;
    }

    /* Title band (like your screenshot, but Chequmate-branded) */
    .band{
      background: linear-gradient(90deg, var(--brand), var(--brand2));
      color: #fff;
      border-bottom: 1px solid rgba(0,0,0,.08);
    }
    .bandwrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 14px 16px;
      font-weight: 900;
      letter-spacing: .2px;
      font-size: 18px;
    }

    /* Main panel */
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 16px 24px;
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: 8px;
      overflow:hidden;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
      min-height: 420px;
    }

    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      .right{ border-left: none !important; border-top: 1px solid var(--divider); }
    }

    .left, .right{
      padding: 22px 22px 18px;
    }

    .right{
      border-left: 1px solid var(--divider);
      background: #fafafa;
    }

    .h2{
      font-size: 14px;
      font-weight: 900;
      margin: 0 0 12px;
      color: #111827;
      letter-spacing: .2px;
    }

    label{
      display:block;
      font-size: 12px;
      font-weight: 800;
      color: #374151;
      margin: 12px 0 6px;
    }

    input, select, button{
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 10px;
      font-size: 14px;
      background: #fff;
      color: var(--text);
      outline: none;
    }
    input:focus, select:focus{
      border-color: rgba(15,118,110,.55);
      box-shadow: 0 0 0 3px rgba(15,118,110,.12);
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-top: 10px;
    }

    .check{
      display:flex;
      align-items:center;
      gap: 8px;
      font-size: 12px;
      color: #374151;
      user-select:none;
    }
    .check input{
      width: 14px;
      height: 14px;
      padding:0;
      margin:0;
    }

    .helpLinks{
      margin-top: 10px;
      font-size: 12px;
    }
    .helpLinks a{
      color: var(--link);
      text-decoration:none;
      font-weight: 800;
    }
    .helpLinks a:hover{ color: var(--linkHover); text-decoration: underline; }

    .btn{
      margin-top: 14px;
      background: var(--btn);
      color: #fff;
      font-weight: 900;
      cursor:pointer;
      border: 1px solid rgba(0,0,0,.08);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
    }
    .btn:hover{ background: var(--btnHover); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .btnSmall{
      margin-top: 10px;
      background: #fff;
      border: 1px solid var(--border);
      color: #111827;
      font-weight: 900;
      cursor:pointer;
    }
    .btnSmall:hover{
      border-color: rgba(15,118,110,.45);
      box-shadow: 0 0 0 3px rgba(15,118,110,.10);
    }

    .note{
      margin-top: 12px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .msg{
      display:none;
      margin-top: 12px;
      border-radius: 6px;
      padding: 10px;
      font-size: 13px;
      border: 1px solid var(--border);
      background: #f9fafb;
      white-space: pre-wrap;
      overflow-wrap:anywhere;
    }
    .msg.ok{ border-color: rgba(6,95,70,.25); background: rgba(6,95,70,.06); color: var(--ok); }
    .msg.err{ border-color: rgba(185,28,28,.25); background: rgba(185,28,28,.06); color: var(--danger); }

    /* Right promo (classic) */
    .promoTitle{
      font-weight: 900;
      font-size: 16px;
      margin: 0 0 10px;
      color: #111827;
    }
    .promoText{
      margin: 0 0 14px;
      color: #374151;
      font-size: 13px;
      line-height: 1.45;
    }

    .promoBox{
      display:flex;
      gap: 14px;
      align-items:center;
      padding: 14px;
      border: 1px solid var(--divider);
      background: #fff;
      border-radius: 8px;
    }

    .phone{
      width: 160px;
      height: 200px;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow:hidden;
      background: #fff;
      display:grid;
      place-items:center;
    }
    .phone img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .phoneFallback{
      text-align:center;
      padding: 10px;
      font-weight: 900;
      color: var(--brand2);
      letter-spacing: .8px;
      font-size: 12px;
    }

    .promoRight{
      flex:1;
      min-width: 0;
    }

    .promoBullets{
      margin: 0 0 10px;
      padding-left: 18px;
      color: #374151;
      font-size: 13px;
      line-height: 1.45;
    }
    .promoBullets li{ margin: 6px 0; }

    .getApp{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }

    .store{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #fff;
      text-decoration:none;
      color: #111827;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
    }
    .store:hover{
      border-color: rgba(15,118,110,.45);
      box-shadow: 0 0 0 3px rgba(15,118,110,.10);
    }

    .cta{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid rgba(0,0,0,.10);
      background: var(--btn);
      color: #fff;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      text-decoration:none;
    }
    .cta:hover{ background: var(--btnHover); }

    /* Footer */
    .footer{
      border-top: 1px solid var(--divider);
      background: #f3f4f6;
      padding: 12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }

    .secure{
      display:flex;
      align-items:center;
      gap: 8px;
      color: #374151;
      font-size: 12px;
      font-weight: 900;
    }
    .lock{
      width: 10px;
      height: 10px;
      border: 1px solid #6b7280;
      border-radius: 2px;
      position: relative;
      opacity: .8;
    }
    .lock:before{
      content:"";
      position:absolute;
      left:2px; right:2px;
      top:-6px;
      height:6px;
      border:1px solid #6b7280;
      border-bottom:none;
      border-radius: 8px 8px 0 0;
      opacity: .8;
    }

    .footlinks{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
      font-size: 12px;
    }
    .footlinks a{
      color: var(--link);
      text-decoration:none;
      font-weight: 900;
    }
    .footlinks a:hover{ color: var(--linkHover); text-decoration: underline; }

    .mutedSmall{
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topwrap">
      <div class="brand">
        <div class="logoBox" aria-label="Chequmate logo">
          <!-- Optional: drop your real logo at static/chequmate_logo.png -->
          <img src="/static/chequmate_logo.png" alt="" onerror="this.remove();document.getElementById('logoFallback').style.display='block';">
          <div id="logoFallback" class="logoFallback" style="display:none;">CQ</div>
        </div>
        <div>
          <div class="wordmark">CHEQUMATE</div>
          <div class="tagline">Broker â€¢ Dispatcher â€¢ Driver</div>
        </div>
      </div>
      <div class="pageTitle">Log In</div>
    </div>
  </header>

  <div class="band">
    <div class="bandwrap">Log in to Chequmate Freight</div>
  </div>

  <main class="wrap">
    <section class="panel" aria-label="Login panel">
      <div class="grid">

        <!-- LEFT: login + create -->
        <div class="left">
          <div class="h2">Access your account</div>

          <!-- LOGIN -->
          <div id="loginPane">
            <label for="login_user">User ID</label>
            <input id="login_user" autocomplete="username" placeholder="Enter your username" />

            <div class="row">
              <div style="flex:1; min-width:0;">
                <label for="login_pass">Password</label>
                <input id="login_pass" type="password" autocomplete="current-password" placeholder="Enter your password" />
              </div>
            </div>

            <div class="row">
              <label class="check">
                <input id="rememberUser" type="checkbox" />
                Save this User ID
              </label>
            </div>

            <button class="btn" id="loginBtn" type="button" onclick="doLogin()">
              <span aria-hidden="true">ðŸ”’</span> Log In
            </button>

            <div class="helpLinks">
              <a href="#" onclick="forgotPassword();return false;">Forgot your password?</a>
            </div>

            <div class="note">
              First time here? Create an account below. Brokers must submit an MC# and will be pending until approved.
            </div>

            <button class="btnSmall" type="button" onclick="showCreate(true)">Create an account</button>
          </div>

          <!-- CREATE -->
          <div id="createPane" style="display:none;">
            <div class="h2">Create an account</div>

            <label for="reg_user">User ID</label>
            <input id="reg_user" autocomplete="username" placeholder="Choose a username" />

            <label for="reg_pass">Password</label>
            <input id="reg_pass" type="password" autocomplete="new-password" placeholder="Create a password (min 8)" />

            <label for="reg_pass2">Confirm password</label>
            <input id="reg_pass2" type="password" autocomplete="new-password" placeholder="Re-enter password" />

            <label for="reg_role">Account type</label>
            <select id="reg_role" onchange="toggleBrokerMC()">
              <option value="driver">Driver</option>
              <option value="dispatcher">Dispatcher</option>
              <option value="broker">Broker</option>
            </select>

            <div id="brokerMCWrap" style="display:none;">
              <label for="reg_broker_mc">Broker MC Number</label>
              <input id="reg_broker_mc" inputmode="numeric" placeholder="MC123456" />
              <div class="note">Required for broker accounts. Status will be <b>pending</b> until approved.</div>
            </div>

            <button class="btn" id="regBtn" type="button" onclick="doRegister()">
              Create Account
            </button>

            <div class="helpLinks" style="margin-top:10px;">
              <a href="#" onclick="showCreate(false);return false;">Back to Log In</a>
              <span class="mutedSmall"> â€¢ </span>
              <a href="#" onclick="forgotPassword();return false;">Forgot your password?</a>
            </div>
          </div>

          <div id="msg" class="msg"></div>
        </div>

        <!-- RIGHT: promo -->
        <div class="right">
          <div class="promoTitle">Stay connected with the Chequmate app</div>
          <p class="promoText">
            Built for freight operations â€” dispatch updates, load details, and driver tools in one place.
          </p>

          <div class="promoBox" aria-label="App promo">
            <div class="phone" title="Chequmate mobile preview">
              <!-- Optional: add static/app_preview.png -->
              <img src="/static/app_preview.png" alt="" onerror="this.remove();document.getElementById('phoneFallback').style.display='block';">
              <div id="phoneFallback" class="phoneFallback" style="display:none;">
                CHEQUMATE<br/>MOBILE
              </div>
            </div>
            <div class="promoRight">
              <ul class="promoBullets">
                <li>Secure access to brokerage, dispatcher, and driver areas</li>
                <li>Fast load workflows â€” no clutter</li>
                <li>Designed for real trucking operations</li>
              </ul>

              <a class="cta" href="#" onclick="toast('App download link not set yet');return false;">
                Get the app
              </a>

              <div class="getApp">
                <a class="store" href="#" onclick="toast('App Store link not set yet');return false;">ï£¿ App Store</a>
                <a class="store" href="#" onclick="toast('Google Play link not set yet');return false;">Google Play</a>
              </div>

              <div class="note">
                (For testing, these buttons can stay placeholders until you publish.)
              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="footer">
        <div class="secure">
          <span class="lock" aria-hidden="true"></span>
          Secure area
        </div>
        <div class="footlinks">
          <a href="#" onclick="toast('Privacy link not set yet');return false;">Privacy</a>
          <a href="#" onclick="toast('Security link not set yet');return false;">Security</a>
          <a href="#" onclick="toast('Support link not set yet');return false;">Support</a>
        </div>
      </div>
    </section>
  </main>

  <script>
    function $(id){ return document.getElementById(id); }

    // Remember username (classic behavior)
    (function bootRemember(){
      try{
        const saved = localStorage.getItem("remember_user") || "";
        if(saved){
          $("login_user").value = saved;
          $("rememberUser").checked = true;
        }
      }catch(e){}
    })();

    function showMsg(kind, text){
      const el = $("msg");
      el.className = "msg " + (kind || "");
      el.style.display = "block";
      el.textContent = text;
    }

    function toast(text){
      showMsg("", text);
      setTimeout(()=>{ $("msg").style.display = "none"; }, 2600);
    }

    function showCreate(on){
      $("msg").style.display = "none";
      $("loginPane").style.display = on ? "none" : "block";
      $("createPane").style.display = on ? "block" : "none";
      if(on){
        toggleBrokerMC();
      }
    }

    function toggleBrokerMC(){
      const role = $("reg_role").value;
      $("brokerMCWrap").style.display = (role === "broker") ? "block" : "none";
    }

    async function apiPOST(path, body){
      const res = await fetch(path, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body || {})
      });
      const j = await res.json().catch(()=>null);
      if(!res.ok){
        const msg = j?.detail || ("HTTP " + res.status);
        throw new Error(msg);
      }
      return j;
    }

    function setAuth(token, username, role, broker_status, broker_mc){
      if(token) localStorage.setItem("token", token);
      if(username) localStorage.setItem("username", username);
      if(role) localStorage.setItem("role", role);
      if(broker_status != null) localStorage.setItem("broker_status", broker_status);
      if(broker_mc != null) localStorage.setItem("broker_mc", broker_mc);
    }

    function goToRole(role){
      if(role === "dispatcher") location.href = "/dispatcher-ui";
      else if(role === "driver") location.href = "/driver-ui";
      else if(role === "broker") location.href = "/broker-ui";
      else location.href = "/broker-ui";
    }

    async function forgotPassword(){
      const email = prompt("Enter the email on your account to request a password reset:");
      if(!email) return;
      try{
        await apiPOST("/password-reset/request", { email: String(email).trim() });
        showMsg("ok", "Password reset request sent (if that email exists). Check your inbox.");
      }catch(e){
        showMsg("err", "Password reset failed: " + (e?.message || e));
      }
    }

    async function doLogin(){
      const u = ($("login_user").value || "").trim();
      const p = ($("login_pass").value || "").trim();
      const remember = $("rememberUser").checked;

      if(!u || !p){
        showMsg("err","Enter your User ID and Password.");
        return;
      }

      try{
        if(remember) localStorage.setItem("remember_user", u);
        else localStorage.removeItem("remember_user");
      }catch(e){}

      $("loginBtn").disabled = true;
      try{
        const j = await apiPOST("/login", { username: u, password: p });

        if(!j || !j.token) throw new Error("Login did not return a token.");

        // Use server-provided role/status (correct behavior)
        const role = j.role || "";
        const broker_status = j.broker_status ?? null;
        const broker_mc = j.broker_mc ?? null;

        setAuth(j.token, u, role, broker_status, broker_mc);

        if(role === "broker" && broker_status && broker_status !== "approved"){
          showMsg("err", "Broker account is " + broker_status + ". You canâ€™t access broker tools until approved.");
          return;
        }

        showMsg("ok","Logged in. Redirectingâ€¦");
        setTimeout(()=>goToRole(role), 500);
      }catch(e){
        showMsg("err","Login failed: " + (e?.message || e));
      }finally{
        $("loginBtn").disabled = false;
      }
    }

    async function doRegister(){
      const u = ($("reg_user").value || "").trim();
      const p = ($("reg_pass").value || "").trim();
      const p2 = ($("reg_pass2").value || "").trim();
      const role = $("reg_role").value;
      const broker_mc = ($("reg_broker_mc").value || "").trim();

      if(!u || !p){
        showMsg("err","Enter a User ID and Password.");
        return;
      }
      if(p.length < 8){
        showMsg("err","Password must be at least 8 characters.");
        return;
      }
      if(p !== p2){
        showMsg("err","Passwords do not match.");
        return;
      }
      if(role === "broker" && !broker_mc){
        showMsg("err","Broker MC Number is required for broker accounts.");
        return;
      }

      $("regBtn").disabled = true;
      try{
        const payload = { username: u, password: p, role: role };
        if(role === "broker") payload.broker_mc = broker_mc;

        await apiPOST("/register", payload);

        showMsg("ok","Account created. Logging you inâ€¦");
        const j = await apiPOST("/login", { username: u, password: p });
        if(!j || !j.token) throw new Error("Login did not return a token.");

        const serverRole = j.role || role;
        const broker_status = j.broker_status ?? null;
        const broker_mc2 = j.broker_mc ?? (role === "broker" ? broker_mc : null);

        setAuth(j.token, u, serverRole, broker_status, broker_mc2);

        if(serverRole === "broker" && broker_status && broker_status !== "approved"){
          showMsg("ok", "Broker account created and is pending approval. You can still test non-broker areas.");
          return;
        }

        setTimeout(()=>goToRole(serverRole), 650);
      }catch(e){
        showMsg("err","Create account failed: " + (e?.message || e));
      }finally{
        $("regBtn").disabled = false;
      }
    }

    // Enter key support (classic)
    document.addEventListener("keydown", (ev)=>{
      if(ev.key !== "Enter") return;
      const createVisible = $("createPane").style.display !== "none";
      if(createVisible) doRegister();
      else doLogin();
    });
  </script>
</body>
</html>
